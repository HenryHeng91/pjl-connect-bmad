# Story 3.5: Automated Customer Tracking Update

**Status:** Draft

**Story:**
**As a** Customer,
**I want** to receive a final confirmation and a tracking link via Telegram once my shipment is on its way,
**so that** I have full visibility of my delivery's history.

**Acceptance Criteria:**
1.  When the shipment status changes to "In Transit", a message is automatically sent to the Customer Telegram bot.
2.  The message includes key details: Carrier Name and Truck Plate Number.
3.  The message contains a unique, publicly accessible web link to a simple page displaying the shipment's event history.
4.  The public tracking page displays the same event history as the back-office view, in reverse chronological order.
5.  The system gracefully handles and logs any failures when sending the Telegram notification.

**Tasks / Subtasks:**
- [ ] Task 1 (AC: 1): Create an event listener that triggers when a shipment's status changes to "In Transit".
- [ ] Task 2 (AC: 3): Implement logic to generate a unique, secure, public-facing token for the shipment's tracking page.
- [ ] Task 3 (AC: 2, 3): In the event listener, send a notification to the Customer Telegram bot using the `TelegramNotificationService`.
- [ ] Task 4 (AC: 4): Create a new public-facing controller and route (e.g., `/track/{token}`) to handle the public tracking link.
- [ ] Task 5 (AC: 4): Create a simple, unauthenticated view to display the shipment's event history. This view should fetch data from the same API endpoint created in Story 3.4.
- [ ] Task 6 (AC: 5): Add error handling and logging to the event listener for the notification sending process.

**Dev Notes:**
*   **External APIs:** This story requires integration with the Telegram Bot API to send messages. [Source: docs/architecture/external-apis.md]
*   **Core Workflow:** This story is part of the "Live Tracking & Customer Communication" workflow.
*   **Data Models:** This story will read from the `shipments` and `shipment_events` tables. The schema is defined in `docs/architecture/database-schema.md`.
*   **Backend:**
    *   Use Laravel's event system to trigger the notification.
    *   Use the `TelegramNotificationService` (`app/Services/TelegramNotificationService.php`) to send the message to the customer. [Source: docs/architecture/components.md]
    *   The public tracking page should be lightweight and require no authentication.
*   **Message Template:**
    ```
    Your shipment is now In Transit!
    Carrier: [Carrier Name]
    Truck Plate: [Truck Plate Number]
    Track its progress here: [Public Tracking Link]
    ```
*   **Testing:**
    *   Backend tests (Pest/PHPUnit) should cover the event listener, the generation of the public tracking link, and the sending of the notification. Mock the Telegram API. [Source: docs/architecture/testing-strategy.md]
    *   Frontend tests (Vitest) should cover the public tracking page, ensuring it correctly displays the event history. [Source: docs/architecture/testing-strategy.md]

**Change Log:**
| Date       | Version | Description                               | Author     |
| :---       | :---    | :---                                      | :---       |
| 2025-09-01 | 2.0     | Aligned with event-based tracking from Story 3.4 | Sarah (PO) |
| 2025-08-28 | 1.0     | Initial draft                             | Bob (SM)   |

**Dev Agent Record:**
*   **Agent Model Used:**
*   **Debug Log References:**
*   **Completion Notes:**
*   **File List:**
*   **Change Log:**

**QA Results:**
*   **QA Agent:**
*   **Review Date:**
*   **Findings:**
*   **Decision:**
*   **Confidence Score:**
*   **Regression Test Plan:**
*   **Notes:**