# Story 3.3: Driver Accepts Job & Initiates Tracking

**Status:** Draft

**Story:**
**As a** Driver,
**I want** to use the forwarded link to view job details and start sharing my location,
**so that** I can easily begin a tracked delivery.

**Acceptance Criteria:**
1.  When the driver clicks the unique link, the system validates that the logged-in Telegram user matches the driver assigned to the job.
2.  If validation is successful, the driver is shown key job details (Shipper, Consignee, Pickup/Delivery addresses, description of goods) within their Telegram app.
3.  If validation fails, an "unauthorized access" error page is displayed.
4.  A "Start Tracking" button is present on the job details view.
5.  Clicking the button prompts the driver to share their live location for 8 hours.
6.  If the driver denies the location sharing request, a message is shown instructing them to manually start sharing.
7.  Once location sharing begins, the shipment status in the Back Office updates to "In Transit".

**Tasks / Subtasks:**
- [ ] Task 1 (AC: 1, 2): Create a controller method to handle the magic link route. This method must validate the token and the driver's Telegram identity.
- [ ] Task 2 (AC: 2): Create a view to display the key job details (Shipper, Consignee, Pickup/Delivery addresses, description of goods).
- [ ] Task 3 (AC: 3): Create a view for unauthorized access errors.
- [ ] Task 4 (AC: 4): Add a "Start Tracking" button to the job details view.
- [ ] Task 5 (AC: 5, 6): Implement the logic for the "Start Tracking" button to request live location sharing (for 8 hours) from the driver using the Telegram Bot API, including handling the denial of the request.
- [ ] Task 6 (AC: 7): Create a webhook handler to receive the live location updates from the driver's Telegram client.
- [ ] Task 7 (AC: 7): When the first location update is received, update the shipment status to "In Transit".

**Dev Notes:**
*   **External APIs:** This story requires integration with the Telegram Bot API to display a web page within the Telegram app and to handle live location sharing. [Source: docs/architecture/external-apis.md]
*   **Core Workflow:** This story is part of the "Live Tracking & Customer Communication" workflow.
*   **Data Models:** This story will update the `status` field in the `shipments` table. The schema is defined in `docs/architecture/database-schema.md`.
*   **Backend:**
    *   Create a new controller, e.g., `app/Http/Controllers/TrackingController.php`, to handle the magic link route and the webhook for location updates. [Source: docs/architecture/backend-architecture.md]
*   **Frontend:**
    *   Create a simple view (e.g., `resources/js/Pages/Tracking/Show.vue`) to display the job details to the driver. This view will be displayed within the Telegram app, so it should be lightweight and mobile-friendly.
    *   **Job Details to Display:** Shipper, Consignee, Pickup Address, Delivery Address, Description of Goods.
*   **Relevant Source Tree:**
    ```
    pjl-connect/
    ├── app/
    │   └── Http/
    │       └── Controllers/
    │           └── TrackingController.php
    ├── resources/
    │   └── js/
    │       └── Pages/
    │           └── Tracking/
    │               └── Show.vue
    ├── routes/
    │   └── web.php
    ```
*   **Security:**
    *   The controller must validate that the Telegram user accessing the link matches the `driver_telegram_username` on the `shipments` table for the given token.
*   **Testing:**
    *   **Test Scenarios:**
        *   Verify that a valid link with the correct driver shows the job details.
        *   Verify that a valid link with an incorrect driver shows an unauthorized error.
        *   Verify that an invalid or expired link shows an error.
        *   Verify that clicking "Start Tracking" initiates the Telegram live location request.
        *   Verify that the shipment status is updated to "In Transit" upon receiving the first location update.
        *   Verify the system handles the driver denying the location sharing request.
    *   Backend tests (Pest/PHPUnit) should cover the `TrackingController`, the location update webhook, and the status update logic. Mock the Telegram API. [Source: docs/architecture/testing-strategy.md]

**Change Log:**
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-08-28 | 1.0 | Initial draft | Bob (SM) |

**Dev Agent Record:**
*   **Agent Model Used:**
*   **Debug Log References:**
*   **Completion Notes:**
*   **File List:**
*   **Change Log:**

**QA Results:**
*   **QA Agent:**
*   **Review Date:**
*   **Findings:**
*   **Decision:**
*   **Confidence Score:**
*   **Regression Test Plan:**
*   **Notes:**