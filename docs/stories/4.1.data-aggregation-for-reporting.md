# Story 4.1: Data Aggregation for Reporting

**Status:** Draft

**Story:**
**As a** Manager,
**I want** the system to collect and process key shipment and financial data points,
**so that** this data is ready for analysis on the dashboard and in exports.

**Acceptance Criteria:**
1.  A nightly scheduled job is created to aggregate key metrics.
2.  The aggregation process considers a shipment as "completed" when its status is 'Delivered'.
3.  The aggregated data is stored in a new `reporting_metrics` table, optimized for quick dashboard retrieval.
4.  The aggregation process calculates the following metrics:
    *   **KPIs:** Total shipment count, total gross weight, total CBM, and total TEUs for various timeframes.
    *   **Financials:** Total Profit & Loss (calculated from the new `invoices` table) and Average Booking Processing Time.
    *   **Rankings:** Top 5 customers and top 5 carriers, ranked by both CBM and gross weight.
    *   **Widget Data:** Count of bookings received this week, count of shipments with status 'In Transit', and count of shipments with status 'Delivered' this week.

**Tasks / Subtasks:**
- [ ] Task 1 (AC: 3): Design and create a database migration for a new `reporting_metrics` table.
- [ ] Task 2 (AC: 4): Enhance the `AnalyticsService` with methods to calculate all required metrics.
- [ ] Task 3 (AC: 4): Implement the logic to calculate "Average Booking Processing Time" (time from booking creation to 'Delivered' status).
- [ ] Task 4 (AC: 4): Implement the logic to calculate "Total Profit & Loss" by summing the P&L from the `invoices` table for completed shipments.
- [ ] Task 5 (AC: 1): Create a new Laravel scheduled command that executes the `AnalyticsService`.
- [ ] Task 6 (AC: 1): Configure the Laravel scheduler to run the aggregation command nightly.
- [ ] Task 7 (AC: 4): Create the necessary API endpoints to expose the aggregated data for the dashboard, including endpoints that support time period filtering.

**Dev Notes:**
*   **Core Workflow:** This story is part of the "Manager Insights & Reporting" workflow.
*   **Data Models:** This story will read from `shipments`, `invoices`, `carriers`, and `companies` tables and write to a new `reporting_metrics` table.
*   **Average Booking Processing Time:** This should be calculated as the average of (`shipment_delivered_timestamp` - `booking_creation_timestamp`). This requires a 'Delivered' timestamp on the shipment.
*   **Total Profit & Loss:** This is calculated by `SUM(invoices.total_price - invoices.total_cost)` for all invoices linked to shipments with a 'Delivered' status within the period.
*   **Proposed `reporting_metrics` Table:** A key-value structure is recommended.
    *   `metric_key` (string, e.g., "kpi_total_pl_this_month")
    *   `metric_value` (JSON)
    *   `updated_at` (timestamp)
*   **Testing:**
    *   Backend tests are critical and must cover every calculation in the `AnalyticsService` to ensure data accuracy.

**Change Log:**
| Date       | Version | Description                               | Author     |
| :---       | :---    | :---                                      | :---       |
| 2025-09-01 | 3.0     | Added P&L and Avg. Processing Time metrics | Sarah (PO) |
| 2025-09-01 | 2.0     | Added specific metrics and requirements | Sarah (PO) |
| 2025-08-28 | 1.0     | Initial draft                             | Bob (SM)   |

**Dev Agent Record:**
*   **Agent Model Used:**
*   **Debug Log References:**
*   **Completion Notes:**
*   **File List:**
*   **Change Log:**

**QA Results:**
*   **QA Agent:**
*   **Review Date:**
*   **Findings:**
*   **Decision:**
*   **Confidence Score:**
*   **Regression Test Plan:**
*   **Notes:**