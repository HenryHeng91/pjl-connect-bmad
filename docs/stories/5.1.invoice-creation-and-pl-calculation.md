# Story 5.1: Invoice Creation and P&L Calculation

**Status:** Draft

**Story:**
**As an** Ops Team Member,
**I want** to create detailed invoices for shipments, linking specific services and automatically calculating costs,
**so that** we can bill customers accurately and determine the profit & loss for each job.

**Acceptance Criteria:**
1.  A new "Invoicing" section is available in the Back Office.
2.  Users can create a new invoice and associate it with a specific shipment.
3.  On the invoice creation page, users can add multiple line items (services) from a predefined list of services.
4.  For each service added, the system automatically determines the `cost` based on the carrier assigned to the shipment.
5.  The user must manually enter the `price` they are charging the customer for each service.
6.  The system calculates and displays the subtotal, total, total cost, and total profit & loss for the invoice.
7.  The created invoice is saved to the database.

**Tasks / Subtasks:**
- [ ] Task 1: Create database migrations for `invoices`, `invoice_items`, and `carrier_service_costs` tables.
- [ ] Task 2: Create the corresponding Eloquent models for the new tables.
- [ ] Task 3: Create the UI for the invoice creation page, including the ability to select a shipment and dynamically add/remove service line items.
- [ ] Task 4: Implement the backend logic to fetch services and their associated costs for the given carrier.
- [ ] Task 5: Implement the backend logic to save the invoice and all its line items.
- [ ] Task 6: Create the necessary API endpoints to support the invoice creation UI.

**Dev Notes:**
*   **Core Workflow:** This story is part of the new "Invoicing and Finance" workflow.
*   **Database Schema Changes:**
    *   **`invoices` table:** `id`, `shipment_id`, `invoice_number`, `total_price`, `total_cost`, `status`, `created_at`.
    *   **`invoice_items` table:** `id`, `invoice_id`, `service_id`, `price`, `cost`.
    *   **`carrier_service_costs` table:** `id`, `carrier_id`, `service_id`, `cost`.
*   **Frontend:**
    *   A new Vue page, `resources/js/Pages/Invoicing/Create.vue`, will be required.
*   **Backend:**
    *   A new `InvoiceController` will be needed to manage the creation and storage of invoices.
*   **Security:**
    *   Access to the invoicing section should be restricted to appropriate user roles (e.g., Ops Team, Managers).
*   **Testing:**
    *   Backend tests should cover the entire invoice creation logic, especially the accuracy of the P&L calculation.
    *   Frontend tests should cover the dynamic nature of the invoice creation form.

**Change Log:**
| Date       | Version | Description   | Author     |
| :---       | :---    | :---          | :---       |
| 2025-09-01 | 1.0     | Initial draft | Sarah (PO) |

**Dev Agent Record:**
*   **Agent Model Used:**
*   **Debug Log References:**
*   **Completion Notes:**
*   **File List:**
*   **Change Log:**

**QA Results:**
*   **QA Agent:**
*   **Review Date:**
*   **Findings:**
*   **Decision:**
*   **Confidence Score:**
*   **Regression Test Plan:**
*   **Notes:**
