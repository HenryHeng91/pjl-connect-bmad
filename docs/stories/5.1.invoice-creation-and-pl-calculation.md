# Story 5.1: Invoice Creation and P&L Calculation

**Status:** Draft

**Story:**
**As an** Ops Team Member,
**I want** to create detailed invoices for shipments, linking specific services and automatically calculating costs,
**so that** we can bill customers accurately and determine the profit & loss for each job.

**Acceptance Criteria:**
1.  A new "Invoicing" section is available in the Back Office.
2.  Users can create a new invoice and associate it with a specific shipment.
3.  On the invoice creation page, users can add multiple line items (services) from a predefined list of services.
4.  For each service added, the system automatically determines the `cost` based on the carrier assigned to the shipment.
5.  The user must manually enter the `price` they are charging the customer for each service.
6.  The system calculates and displays the subtotal, total, total cost, and total profit & loss for the invoice.
7.  The created invoice is saved to the database.
8.  If a selected service has no defined cost for the assigned carrier, the system displays an alert and prevents the invoice from being saved.

**Tasks / Subtasks:**
- [ ] Task 1 (AC: 2, 7): Create database migrations for `invoices`, `invoice_items`, and `carrier_service_costs` tables.
- [ ] Task 2 (AC: 7): Create the corresponding Eloquent models for the new tables.
- [ ] Task 3 (AC: 1, 2, 3, 5): Create the UI for the invoice creation page, including the ability to select a shipment and dynamically add/remove service line items.
- [ ] Task 4 (AC: 4, 8): Implement the backend logic to fetch services and their associated costs for the given carrier.
- [ ] Task 5 (AC: 6, 7): Implement the backend logic to save the invoice and all its line items.
- [ ] Task 6 (AC: 3, 4, 5, 6): Create the necessary API endpoints to support the invoice creation UI.

**Dev Notes:**
*   **Source Documents:**
    *   Database Schema: `docs/architecture/database-schema.md`
    *   Data Models: `docs/architecture/data-models.md`
*   **Core Workflow:** This story is part of the new "Invoicing and Finance" workflow.
*   **Database Schema Changes:** (Aligned with `database-schema.md`)
    *   **`invoices` table:** `id`, `shipment_id`, `invoice_number`, `total_price`, `total_cost`, `status`, `created_at`, `updated_at`.
    *   **`invoice_items` table:** `id`, `invoice_id`, `service_id`, `price`, `cost`.
    *   **`carrier_service_costs` table:** `id`, `carrier_id`, `service_id`, `cost`, `created_at`, `updated_at`.
*   **UI/Frontend Specifications:**
    *   The main page will be `resources/js/Pages/Invoicing/Create.vue`.
    *   **Layout:**
        *   **Shipment Selector:** A dropdown/searchable input to select the shipment to be invoiced.
        *   **Line Items Section:**
            *   A table displaying current line items with columns for "Service", "Price" (editable input), "Cost" (read-only), and a "Remove" button.
            *   An "Add Service" button below the table. Clicking it adds a new row to the table with a dropdown to select a service.
        *   **Summary Section:** A read-only section displaying `Subtotal`, `Total Cost`, and `P&L`.
        *   **Actions:** "Save Invoice" and "Cancel" buttons.
*   **Backend:**
    *   A new `InvoiceController` will be needed to manage the creation and storage of invoices.
*   **Security:**
    *   Access to the invoicing section should be restricted to appropriate user roles (e.g., Ops Team, Managers) using middleware.
*   **Testing:**
    *   **Backend (Pest/PHPUnit):**
        *   Create feature tests for the invoice creation endpoint.
        *   Verify that the P&L calculation is correct.
        *   Test the error handling when a service cost is missing for a carrier (AC 8).
        *   Ensure database transactions are used to save the invoice and its items together.
    *   **Frontend (Vitest):**
        *   Test that adding and removing line items works correctly.
        *   Verify that the summary calculations update automatically when prices are changed or items are added/removed.

**Change Log:**
| Date       | Version | Description   | Author     |
| :---       | :---    | :---          | :---       |
| 2025-09-01 | 1.0     | Initial draft | Sarah (PO) |
| 2025-09-02 | 1.1     | Added UI specs, corrected DB schema, and improved detail. | Sarah (PO) |

**Dev Agent Record:**
*   **Agent Model Used:**
*   **Debug Log References:**
*   **Completion Notes:**
*   **File List:**
*   **Change Log:**

**QA Results:**
*   **QA Agent:**
*   **Review Date:**
*   **Findings:**
*   **Decision:**
*   **Confidence Score:**
*   **Regression Test Plan:**
*   **Notes:**
