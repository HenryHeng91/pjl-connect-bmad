# Story 2.5: Carrier Bot Dispatch & Response

**Status:** Draft

**Story:**
**As a** Carrier,
**I want** to receive new job offers on my Telegram bot and be able to accept or decline them simply,
**so that** I can manage my incoming work efficiently.

**Acceptance Criteria:**
1.  Clicking "Dispatch to Carrier" sends a notification to all associated staff for that carrier via the Carrier Telegram bot.
2.  The message contains booking details and "Accept"/"Decline" buttons.
3.  The system logs which specific staff member responded.
4.  If **accepted**, the shipment status is updated to "Awaiting Carrier Info", and the carrier is prompted to provide truck details.
5.  If **declined**, the shipment status is updated to "Carrier Declined", and the assigned Ops member is alerted.

**Tasks / Subtasks:**
- [ ] Task 1 (AC: 1): Implement the logic to send a notification to the Carrier Telegram bot when a shipment is dispatched.
- [ ] Task 2 (AC: 2): Format the notification message to include booking details and "Accept"/"Decline" buttons.
- [ ] Task 3 (AC: 3): Implement the callback handlers for the "Accept" and "Decline" buttons.
    - [ ] Sub-task 3.1: Log the responding staff member's ID when a button is clicked.
- [ ] Task 4 (AC: 4): If the job is accepted, update the shipment status and send a follow-up message to the carrier asking for truck details.
- [ ] Task 5 (AC: 5): If the job is declined, update the shipment status and send a notification to the assigned Ops member.

**Dev Notes:**
*   **External APIs:** This story requires integration with the Telegram Bot API to send notifications and handle button callbacks. [Source: docs/architecture/external-apis.md]
*   **Core Workflow:** This story is a key part of the "New Booking Ingestion" workflow. [Source: docs/architecture/core-workflows.md]
*   **Data Models:** This story will update the `shipments` table. The schema is defined in `docs/architecture/database-schema.md`.
*   **Backend:**
    *   Use the `TelegramNotificationService` to send the messages. [Source: docs/architecture/components.md]
    *   Create a new `CarrierBotController` at `app/Http/Controllers/Api/CarrierBotController.php` to handle the button callbacks from the Telegram bot.
*   **Security:** Webhook callbacks from Telegram should be validated to ensure they are legitimate. This can be done using a secret token passed in the webhook URL.

**Testing:**
*   Backend tests (Pest/PHPUnit) should cover the notification sending and the callback handlers for both the accept and decline scenarios. It would be beneficial to mock the Telegram API.
*   Tests must also cover the validation of the incoming Telegram webhook.

**Change Log:**
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-08-28 | 1.0 | Initial draft | Bob (SM) |
| 2025-08-31 | 1.1 | Added sub-task for logging, specified controller, added security note, and restructured testing. | Sarah (PO) |

**Dev Agent Record:**
*   **Agent Model Used:**
*   **Debug Log References:**
*   **Completion Notes:**
*   **File List:**
*   **Change Log:**

**QA Results:**
*   **QA Agent:**
*   **Review Date:**
*   **Findings:**
*   **Decision:**
*   **Confidence Score:**
*   **Regression Test Plan:**
*   **Notes:**