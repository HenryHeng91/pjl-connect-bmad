# Story 3.2: Dynamic Driver Assignment Link Generation

**Status:** Draft

**Story:**
**As a** Carrier,
**I want** the system to provide a unique "magic link" for each job,
**so that** I can securely forward it to my assigned driver to begin the tracking process.

**Acceptance Criteria:**
1.  When the driver's Telegram username is submitted, the system generates a unique, single-use link.
2.  The Carrier Bot sends this link back to the carrier staff member who is managing the booking.
3.  The message includes an instruction for the carrier to forward this link to the assigned driver.
4.  The magic link can only be used once to access the tracking page. Subsequent attempts to use the same link will result in an error or an expired link page.
5.  The system gracefully handles failures in token generation or Telegram message sending, and logs the error.

**Tasks / Subtasks:**
- [ ] Task 1 (AC: 1): Implement the logic to generate a unique, single-use, and secure token associated with the shipment.
- [ ] Task 2 (AC: 1): Create a new route in `routes/web.php` that will be used for the magic link (e.g., `/track/{token}`).
- [ ] Task 3 (AC: 4): Implement logic to invalidate the token after its first use.
- [ ] Task 4 (AC: 4): Create a view for an expired or invalid link page.
- [ ] Task 5 (AC: 2): After the driver's Telegram username is submitted, send a message to the carrier with the generated magic link.
- [ ] Task 6 (AC: 3): The message should include clear instructions for the carrier to forward the link to the driver.
- [ ] Task 7 (AC: 5): Implement error handling and logging for the token generation and message sending processes.

**Dev Notes:**
*   **External APIs:** This story requires integration with the Telegram Bot API to send messages. [Source: docs/architecture/external-apis.md]
*   **Core Workflow:** This story is part of the "Live Tracking & Customer Communication" workflow.
*   **Data Models:** This story will likely require a new table to store the magic tokens and their association with shipments, or a new field in the `shipments` table.
*   **Backend:**
    *   The token generation logic should be secure and produce a unique, hard-to-guess token for each shipment.
    *   Use the `TelegramNotificationService` (`app/Services/TelegramNotificationService.php`) to send the message to the carrier. [Source: docs/architecture/components.md]
*   **Relevant Source Tree:**
    ```
    pjl-connect/
    ├── app/
    │   └── Services/
    │       └── TelegramNotificationService.php
    ├── resources/
    │   └── js/
    │       └── Pages/
    │           └── ExpiredLink.vue
    ├── routes/
    │   └── web.php
    ```
*   **Security:**
    *   The magic link should be single-use to prevent unauthorized access.
*   **Testing:**
    *   **Test Scenarios:**
        *   Verify that a unique token is generated for each shipment.
        *   Verify that the magic link is sent to the carrier.
        *   Verify that accessing the magic link for the first time works correctly.
        *   Verify that accessing the magic link a second time shows the expired link page.
        *   Verify that an invalid token shows the expired link page.
        *   Verify that errors during token generation are logged.
        *   Verify that errors during message sending are logged.
    *   **Test Data:**
        *   Sample shipment data.
        *   Sample carrier data.
        *   Sample driver data.
    *   Backend tests (Pest/PHPUnit) should cover the token generation logic and the sending of the magic link to the carrier. [Source: docs/architecture/testing-strategy.md]

**Change Log:**
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-08-28 | 1.0 | Initial draft | Bob (SM) |

**Dev Agent Record:**
*   **Agent Model Used:**
*   **Debug Log References:**
*   **Completion Notes:**
*   **File List:**
*   **Change Log:**

**QA Results:**
*   **QA Agent:**
*   **Review Date:**
*   **Findings:**
*   **Decision:**
*   **Confidence Score:**
*   **Regression Test Plan:**
*   **Notes:**