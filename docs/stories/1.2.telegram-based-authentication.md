# Story 1.2: Telegram-based Authentication

**Status:** Ready for Review

**Story:**
**As an** Ops Team Member,
**I want** to log into the Back Office system using my Telegram account,
**so that** I can access the platform securely without managing a separate password.

**Acceptance Criteria:**
1.  A "Login with Telegram" button is present on the application's login page.
2.  Clicking the button initiates the standard Telegram OAuth authentication flow.
3.  Upon successful authentication, a user session is created, and the user is redirected to the main dashboard.
4.  An unsuccessful or denied authentication attempt displays a clear error message to the user.

**Tasks / Subtasks:**
- [x] Task 1 (AC: 1): Create a login page with a "Login with Telegram" button.
- [x] Task 2 (AC: 2): Implement the Telegram Login Widget and the authentication callback handler.
- [x] Task 3 (AC: 2): **Validate the data hash received from the Telegram callback to ensure data integrity and prevent spoofing.**
- [x] Task 4 (AC: 3): Create a user session on successful authentication and redirect to the dashboard.
- [x] Task 5 (AC: 4): Implement error handling for failed authentication attempts.

**Dev Notes:**
*   **UI/UX Guidance:**
    *   The login page should be centered on a clean, white background.
    *   It should display the application name "PJL-Connect" prominently at the top.
    *   Below the name, display a single, large "Login with Telegram" button. The button style should match the official Telegram brand colors.
*   **File Paths:**
    *   **Controller:** Create the new controller at `app/Http/Controllers/Auth/TelegramLoginController.php`.
    *   **Frontend Component:** Create the new login page component at `resources/js/Pages/Auth/Login.vue`.
*   **Authentication Flow:** The implementation should follow the standard Telegram Login Widget flow. [Source: docs/architecture/backend-architecture.md]
*   **External APIs:** This story requires integration with the Telegram Bot API. [Source: docs/architecture/external-apis.md]
*   **Frontend:**
    *   The login page will be the `Login.vue` component. [Source: docs/architecture/frontend-architecture.md]
    *   Use Pinia for state management to handle the authenticated user state. [Source: docs/architecture/frontend-architecture.md]
*   **Backend:**
    *   Use Laravel's built-in authentication scaffolding (Breeze) as a starting point if applicable, but the primary authentication mechanism will be Telegram. [Source: docs/architecture/tech-stack.md]
    *   The `TelegramLoginController.php` will handle the Telegram login callback. [Source: docs/architecture/backend-architecture.md]
*   **Testing:**
    *   Frontend tests (Vitest) should cover the login button and the display of error messages. [Source: docs/architecture/testing-strategy.md]
    *   Backend tests (Pest/PHPUnit) should cover the Telegram callback handler, **security hash validation**, user session creation, and error handling. [Source: docs/architecture/testing-strategy.md]

**Change Log:**
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-08-28 | 1.0 | Initial draft | Bob (SM) |

**Dev Agent Record:**
*   **Agent Model Used:** James (Dev)
*   **Debug Log References:**
*   **Completion Notes:**
    *   Implemented Telegram-based authentication, including login page, controller, and callback handler.
    *   Added hash validation for security.
    *   Integrated user session creation and redirection to dashboard.
    *   Implemented error handling for failed authentication attempts.
    *   Created migration to add `telegram_id` and `username` to users table.
    *   Wrote comprehensive backend (Pest) and frontend (Vitest) tests.
    *   Fixed Vite configuration to correctly handle Vue files.
*   **File List:**
    *   `resources/js/Pages/Auth/Login.vue` (created/modified)
    *   `app/Http/Controllers/Auth/TelegramLoginController.php` (created/modified)
    *   `routes/web.php` (modified)
    *   `database/migrations/2025_09_02_095619_add_telegram_id_to_users_table.php` (created/modified)
    *   `app/Models/User.php` (modified)
    *   `resources/js/Pages/Dashboard.vue` (created)
    *   `tests/Feature/TelegramLoginTest.php` (created)
    *   `resources/js/Pages/Auth/Login.test.js` (created/modified)
    *   `resources/views/app.blade.php` (created)
    *   `bootstrap/app.php` (modified)
    *   `resources/js/app.js` (modified)
    *   `package.json` (modified)
    *   `vitest.config.js` (created)
*   **Change Log:**
| Date       | Version | Description   | Author     |
| :---       | :---    | :---          | :---       |
| 2025-09-02 | 1.1     | Implemented Telegram-based authentication. | James (Dev) |

**QA Results:**
*   **QA Agent:** Quinn
*   **Review Date:** 2025-09-02
*   **Findings:**
    *   **AC1 (Login button present):** Fully covered by `resources/js/Pages/Auth/Login.test.js` (`test('Telegram login widget script and div are present')`).
    *   **AC2 (Initiates Telegram OAuth):** Fully covered by `tests/Feature/TelegramLoginTest.php` (`test_a_user_can_login_with_valid_telegram_data()`).
    *   **AC3 (User session & redirect):** Fully covered by `tests/Feature/TelegramLoginTest.php` (`test_a_user_can_login_with_valid_telegram_data()`).
    *   **AC4 (Error message on failure):** Fully covered by `tests/Feature/TelegramLoginTest.php` (`test_it_returns_an_error_with_invalid_hash()`, `test_it_returns_an_error_if_user_denies_access()`) and `resources/js/Pages/Auth/Login.test.js` (`test('Error message is displayed')`).
*   **Decision:** PASS
*   **Confidence Score:** High
*   **Regression Test Plan:**
    *   Run `php artisan test` to execute backend tests.
    *   Run `npm test` to execute frontend tests.
*   **Notes:** Comprehensive test coverage for all acceptance criteria. The implementation correctly handles successful authentication, user creation/login, and various error scenarios. The `telegram_id` and `username` columns were correctly added to the `users` table via migration, and the `User` model was updated accordingly.
